<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stock.bookinventory.mapper.OrderMapper">

    <!-- Result Map -->
    <resultMap id="OrderResultMap" type="com.stock.bookinventory.model.Order">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="customerId" column="customer_id" jdbcType="BIGINT"/>
        <result property="orderDate" column="order_date" jdbcType="DATE"/>
        <result property="status" column="status" jdbcType="VARCHAR"/>
        <result property="totalAmount" column="total_amount" jdbcType="DECIMAL"/>
        <result property="orderAt" column="order_at" jdbcType="TIMESTAMP"/>
        <result property="expiresAt" column="expires_at" jdbcType="TIMESTAMP"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Insert Order -->
    <insert id="insert" parameterType="com.stock.bookinventory.model.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO orders (customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at)
        VALUES (#{customerId}, #{orderDate}, #{status}, #{totalAmount}, #{orderAt}, #{expiresAt}, NOW(), NOW())
    </insert>

    <!-- Find All Orders -->
    <select id="findAll" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        ORDER BY id DESC
    </select>

    <!-- Find Order By ID -->
    <select id="findById" parameterType="long" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE id = #{id}
    </select>

    <!-- Select Order By ID -->
    <select id="selectById" parameterType="long" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE id = #{id}
    </select>

    <!-- Get Order For Update (with row lock) -->
    <select id="getOrderForUpdate" parameterType="long" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE id = #{id}
        FOR UPDATE
    </select>

    <!-- Update Order -->
    <update id="update" parameterType="com.stock.bookinventory.model.Order">
        UPDATE orders
        SET customer_id = #{customerId},
            order_date = #{orderDate},
            status = #{status},
            total_amount = #{totalAmount},
            order_at = #{orderAt},
            expires_at = #{expiresAt},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Update Order Status -->
    <update id="updateStatus">
        UPDATE orders
        SET status = #{status},
            updated_at = NOW()
        WHERE id = #{orderId}
    </update>

    <!-- Update Order Total Amount -->
    <update id="updateTotalAmount">
        UPDATE orders
        SET total_amount = #{totalAmount},
            updated_at = NOW()
        WHERE id = #{orderId}
    </update>

    <!-- Delete Order By ID -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM orders
        WHERE id = #{id}
    </delete>

    <!-- Find Orders By Customer ID -->
    <select id="findByCustomerId" parameterType="long" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE customer_id = #{customerId}
        ORDER BY id DESC
    </select>

    <!-- Find Orders By Status -->
    <select id="findByStatus" parameterType="string" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE status = #{status}
        ORDER BY id DESC
    </select>

    <!-- Find Orders By Criteria (dynamic SQL) -->
    <select id="findByCriteria" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        <where>
            <if test="customerId != null">
                AND customer_id = #{customerId}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="minTotalAmount != null">
                AND total_amount &gt;= #{minTotalAmount}
            </if>
            <if test="maxTotalAmount != null">
                AND total_amount &lt;= #{maxTotalAmount}
            </if>
            <if test="startDate != null">
                AND order_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND order_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY id DESC
    </select>

    <!-- Find Expired Orders -->
    <select id="findExpiredOrders" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE expires_at &lt; NOW()
          AND status != 'COMPLETED'
          AND status != 'CANCELLED'
        ORDER BY expires_at ASC
    </select>

    <!-- Find Pending Orders -->
    <select id="findPendingOrders" resultMap="OrderResultMap">
        SELECT id, customer_id, order_date, status, total_amount, order_at, expires_at, created_at, updated_at
        FROM orders
        WHERE status = 'PENDING'
        ORDER BY id DESC
    </select>

    <!-- Count Total Orders -->
    <select id="countTotal" resultType="long">
        SELECT COUNT(*)
        FROM orders
    </select>

    <!-- Count Orders By Status -->
    <select id="countByStatus" parameterType="string" resultType="long">
        SELECT COUNT(*)
        FROM orders
        WHERE status = #{status}
    </select>

    <!-- Count Orders By Customer ID -->
    <select id="countByCustomerId" parameterType="long" resultType="long">
        SELECT COUNT(*)
        FROM orders
        WHERE customer_id = #{customerId}
    </select>

    <!-- Calculate Total Revenue -->
    <select id="calculateTotalRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM orders
        WHERE status = 'COMPLETED'
    </select>

    <!-- Calculate Total Revenue By Date Range -->
    <select id="calculateRevenueByDateRange" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM orders
        WHERE status = 'COMPLETED'
          AND order_date BETWEEN #{startDate} AND #{endDate}
    </select>

</mapper>
