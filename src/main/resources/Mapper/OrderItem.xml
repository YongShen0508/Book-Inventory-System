<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stock.bookinventory.mapper.OrderItemMapper">

    <!-- Result Map -->
    <resultMap id="OrderItemResultMap" type="com.stock.bookinventory.model.OrderItem">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="orderId" column="order_id" jdbcType="BIGINT"/>
        <result property="bookId" column="book_id" jdbcType="BIGINT"/>
        <result property="quantity" column="quantity" jdbcType="INTEGER"/>
        <result property="subtotal" column="subtotal" jdbcType="DECIMAL"/>
        <result property="status" column="status" jdbcType="VARCHAR"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Insert Order Item -->
    <insert id="insert" parameterType="com.stock.bookinventory.model.OrderItem" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO order_item (order_id, book_id, quantity, subtotal, status, created_at, updated_at)
        VALUES (#{orderId}, #{bookId}, #{quantity}, #{subtotal}, #{status}, NOW(), NOW())
    </insert>

    <!-- Batch Insert Order Items -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO order_item (order_id, book_id, quantity, subtotal, status, created_at, updated_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.orderId}, #{item.bookId}, #{item.quantity}, #{item.subtotal}, #{item.status}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- Find All Order Items -->
    <select id="findAll" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        ORDER BY id DESC
        <if test="pageSize != null and offset != null">
            LIMIT #{pageSize} OFFSET #{offset}
        </if>
    </select>

    <!-- Find Order Item By ID -->
    <select id="findById" parameterType="long" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE id = #{id}
    </select>

    <!-- Select Order Item By ID -->
    <select id="selectById" parameterType="long" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE id = #{id}
    </select>

    <!-- Get Order Item For Update (with row lock) -->
    <select id="getOrderItemForUpdate" parameterType="long" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE id = #{id}
        FOR UPDATE
    </select>

    <!-- Update Order Item -->
    <update id="update" parameterType="com.stock.bookinventory.model.OrderItem">
        UPDATE order_item
        SET order_id = #{orderId},
        book_id = #{bookId},
        quantity = #{quantity},
        subtotal = #{subtotal},
        status = #{status},
        updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- Update Order Item Status -->
    <update id="updateStatus">
        UPDATE order_item
        SET status = #{status},
        updated_at = NOW()
        WHERE id = #{orderItemId}
    </update>

    <!-- Update Order Item Quantity -->
    <update id="updateQuantity">
        UPDATE order_item
        SET quantity = #{quantity},
        subtotal = #{subtotal},
        updated_at = NOW()
        WHERE id = #{orderItemId}
    </update>

    <!-- Delete Order Item By ID -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM order_item
        WHERE id = #{id}
    </delete>

    <!-- Delete Order Items By Order ID -->
    <delete id="deleteByOrderId" parameterType="long">
        DELETE FROM order_item
        WHERE order_id = #{orderId}
    </delete>

    <!-- Find Order Items By Order ID -->
    <select id="findByOrderId" parameterType="long" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE order_id = #{orderId}
        ORDER BY id ASC
    </select>

    <!-- Find Order Items By Book ID -->
    <select id="findByBookId" parameterType="long" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE book_id = #{bookId}
        ORDER BY id DESC
    </select>

    <!-- Find Order Items By Status -->
    <select id="findByStatus" parameterType="string" resultMap="OrderItemResultMap">
        SELECT id, order_id, book_id, quantity, subtotal, status, created_at, updated_at
        FROM order_item
        WHERE status = #{status}
        ORDER BY id DESC
    </select>

    <!-- Calculate Total By Order ID -->
    <select id="calculateTotalByOrderId" parameterType="long" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(subtotal), 0)
        FROM order_item
        WHERE order_id = #{orderId}
    </select>

    <!-- Get Total Quantity By Order ID -->
    <select id="getTotalQuantityByOrderId" parameterType="long" resultType="int">
        SELECT COALESCE(SUM(quantity), 0)
        FROM order_item
        WHERE order_id = #{orderId}
    </select>

    <!-- Check If Order Item Exists -->
    <select id="existsByOrderIdAndBookId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM order_item
        WHERE order_id = #{orderId}
        AND book_id = #{bookId}
    </select>

</mapper>
